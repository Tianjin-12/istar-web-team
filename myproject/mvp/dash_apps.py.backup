# mvp/dash_apps.py
from django_plotly_dash import DjangoDash
from dash.dependencies import Output, Input, State
import dash_bootstrap_components as dbc
import os
import json
import subprocess
import dash
from dash import dcc, html, dash_table
from dash.dependencies import Input, Output, State
import dash_bootstrap_components as dbc
import plotly.express as px
import plotly.graph_objects as go
import pandas as pd
import numpy as np 
import requests
from datetime import timedelta,datetime
from django.urls import reverse
# åˆ›å»ºDjangoDashå®ä¾‹ï¼Œåç§°å¿…é¡»ä¸æ¨¡æ¿ä¸­çš„nameå±æ€§åŒ¹é…
app = DjangoDash('DashboardApp', external_stylesheets=["/static/css/bootstrap.min.css","/static/css/bootstrap-icons.css",  "/static/css/style.css"],
                  suppress_callback_exceptions=True,
                  serve_locally=True)

# --- 1. å¤šè¯­è¨€é…ç½® ---
TRANSLATIONS = {
    'zh': {
        'nav_dash': 'ä»ªè¡¨ç›˜', 'nav_rank': 'è¡Œä¸šæ¦œå•',
        'nav_wiki': 'AI çŸ¥è¯†åº“', 'nav_setting': 'ç³»ç»Ÿè®¾ç½®',
        'login': 'ç™»å½•', 'welcome': 'ç®¡ç†å‘˜', 'guest': 'æ¸¸å®¢è®¿é—®',
        # æœç´¢åŒº
        'lbl_brand': 'ç›‘æµ‹å¯¹è±¡', 'ph_brand': 'å“ç‰Œåç§° (å¦‚: Nike)',
        'lbl_kw': 'æ ¸å¿ƒå…³é”®è¯', 'ph_kw': 'å…³é”®è¯ (å¦‚: è“ç‰™è€³æœº)',
        'lbl_link': 'é“¾æ¥åœ°å€', 'ph_link': 'è¯·è¾“å…¥é“¾æ¥åœ°å€ (å¦‚: https://example.com)',
        'btn_start': 'å¼€å§‹åˆ†æ',
        # KPI & å›¾è¡¨
        'kpi_vis': 'æ ¸å¿ƒå“ç‰ŒæåŠæ¦‚ç‡(æ¨èæ€§ä»»åŠ¡)', 'kpi_sent': 'é“¾æ¥æåŠæ¦‚ç‡',
        'kpi_rev': 'å“ç‰ŒæåŠæ¦‚ç‡ï¼ˆéšæ„æ€§ä»»åŠ¡ï¼‰', 'chart_trend': 'æµé‡æ¥æºè¶‹åŠ¿åˆ†æ',
        'chart_rank': 'ç«å“å¯è§åº¦æ’è¡Œ ', 'chart_pie': 'AI å¹³å°æ¨èä»½é¢',
        'download': 'å¯¼å‡ºåˆ†ææŠ¥å‘Š', 'lang_label': 'EN'
    },
    'en': {
        'nav_dash': 'Dashboard', 'nav_rank': 'Rankings',
        'nav_wiki': 'Wiki', 'nav_setting': 'Settings',
        'login': 'Login', 'welcome': 'Admin', 'guest': 'Guest Mode',
        # Search Section
        'lbl_brand': 'Target Brand', 'ph_brand': 'e.g. Nike',
        'lbl_kw': 'Keywords', 'ph_kw': 'e.g. Wireless Earbuds',
        'lbl_link': 'Link URL', 'ph_link': 'Enter link URL (e.g., https://example.com)',
        'btn_start': 'Analyze',
        # KPI & Charts
        'kpi_vis': 'Core Brand Mention percentage(recommend task)', 'kpi_sent': 'Link Mention percentage',
        'kpi_rev': 'Brand Mention percentage(random task)', 'chart_trend': 'Traffic Source Trends',
        'chart_rank': 'Visibility Ranking', 'chart_pie': 'AI Rec. Share',
        'download': 'Export Report', 'lang_label': 'ä¸­'
    }
}

def fetch_backend_data(brand_name=None, keyword_name=None,link_name=None):
    # APIç«¯ç‚¹URL
    base_url = os.environ.get("https://istar-geo.com",'http://localhost:8000')
    api_url = f"{base_url}/api/dashboard-data/"
    # æ„å»ºæŸ¥è¯¢å‚æ•°
    params = {}
    if brand_name:
        params['brand_name'] = brand_name
    if keyword_name:
        params['keyword'] = keyword_name
    if link_name:
        params['link'] = link_name
    params['days'] = 30  # é»˜è®¤è·å–30å¤©çš„æ•°æ®
    
    try:
        # å‘é€GETè¯·æ±‚åˆ°API
        response = requests.get(api_url, params=params, timeout=100)
        
        # æ£€æŸ¥å“åº”çŠ¶æ€
        if response.status_code == 200:
            # è§£æJSONå“åº”
            data = response.json()
            
            if data.get('status') == 'success':
                # è·å–APIæ•°æ®
                api_data = data.get('data', [])
                
                if not api_data:
                    # å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œè¿”å›ç‰¹æ®Šæ ‡è®°
                    return {"no_data": True, "brand_name": brand_name, "keyword_name": keyword_name,"link_name": link_name}
                
                # å°†APIæ•°æ®è½¬æ¢ä¸ºDataFrame
                df = pd.DataFrame(api_data)
                
                print(type(df))
                # è½¬æ¢ä¸ºç½‘é¡µéœ€è¦çš„æ•°æ®æ ¼å¼
                return df
            elif data.get('status') == 'no_data':
                # APIè¿”å›æ²¡æœ‰æ•°æ®çš„æ ‡è®°
                return {"no_data": True, "brand_name": data.get('brand_name', brand_name), "keyword_name": data.get('keyword_name', keyword_name),"link_name":data.get("link_name",link_name)}
            elif data.get('status') == 'no_order':
                # APIè¿”å›æ²¡æœ‰è®¢å•çš„æ ‡è®°
                return {"no_order": True, "brand_name": data.get('brand_name', brand_name), "keyword": data.get('keyword', keyword_name)}
            else:
                # APIè¿”å›é”™è¯¯
                print(f"APIè¿”å›é”™è¯¯: {data.get('error', 'æœªçŸ¥é”™è¯¯')}")
                return {"no_data": True, "brand_name": brand_name, "keyword_name": keyword_name,"link_name":link_name}
        else:
            # HTTPé”™è¯¯
            print(f"HTTPé”™è¯¯ {response.status_code}: {response.text}")
            return {"no_data": True, "brand_name": brand_name, "keyword_name": keyword_name,"link_name":link_name}
            
    except requests.exceptions.RequestException as e:
        # ç½‘ç»œè¯·æ±‚å¼‚å¸¸
        print(f"ç½‘ç»œè¯·æ±‚å¼‚å¸¸: {str(e)}")
        return {"no_data": True, "brand_name": brand_name, "keyword_name": keyword_name,"link_name":link_name}
    except Exception as e:
        # å…¶ä»–å¼‚å¸¸
        print(f"å¤„ç†æ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸: {str(e)}")
        return {"no_data": True, "brand_name": brand_name, "keyword_name": keyword_name,"link_name":link_name}
 

def _convert_to_web_format(df,brand_name):
    # å¤„ç†è¶‹åŠ¿å›¾æ•°æ®
    if not isinstance(df, pd.DataFrame) or df.empty:
        return _get_default_data()
    trend_data = {
        "Date": [],
        "Brand": [],
        "Link": []
    }
    focus_df = df[df["brand_name"] == brand_name]
    # æŒ‰æ—¥æœŸåˆ†ç»„å¹¶è®¡ç®—å¹³å‡å€¼
    
    focus_df["created_at"] = pd.to_datetime(focus_df["created_at"])
    df["created_at"] = pd.to_datetime(df["created_at"])
        # è·å–æœ€è¿‘çš„æ—¥æœŸ
    latest_date = focus_df["created_at"].max()    
        # ç­›é€‰å‡ºæœ€è¿‘æ—¥æœŸçš„æ•°æ®
    latest_data = focus_df[focus_df["created_at"] == latest_date]   
        # è®¡ç®—æœ€è¿‘ä¸€å¤©çš„å¹³å‡å€¼
    latest_r_brand_amount = latest_data['r_brand_amount'].mean()
    latest_nr_brand_amount = latest_data['nr_brand_amount'].mean()
    latest_link_amount = latest_data['link_amount'].mean()
    grouped = focus_df.groupby("created_at").agg({
            'r_brand_amount': 'mean',
            'link_amount': 'mean'
        }).reset_index()
        
        # æŒ‰æ—¥æœŸæ’åº
    grouped = grouped.sort_values("created_at")
        
        # å°†æ—¥æœŸè½¬æ¢ä¸ºå­—ç¬¦ä¸²æ ¼å¼
    trend_data["Date"] = grouped["created_at"].dt.strftime('%Y-%m-%d').tolist()
    trend_data["Brand"] = grouped['r_brand_amount'].tolist()
    trend_data["Link"] = grouped['link_amount'].tolist()
   
    # å¤„ç†æ’è¡Œæ¦œæ•°æ®
    ranking_data = pd.DataFrame(columns=['Brand', 'Score', 'Rank'])
    if 'brand_name' in df.columns and 'r_brand_amount' in df.columns and 'link_amount' in df.columns:
        # æŒ‰å“ç‰Œåˆ†ç»„ï¼Œè®¡ç®—brand_amountå’Œlink_amountçš„å¹³å‡å€¼
        brand_stats = df.groupby('brand_name').agg({
            'r_brand_amount': 'mean',
            'link_amount': 'mean'
        }).reset_index()
        
        # è®¡ç®—æ€»åˆ†ï¼ˆbrand_amount + link_amountï¼‰
        brand_stats['total_score'] = brand_stats['r_brand_amount'] + brand_stats['link_amount']
        
        # æŒ‰æ€»åˆ†é™åºæ’åˆ—
        brand_stats = brand_stats.sort_values('total_score', ascending=False).reset_index(drop=True)
        
        # æ·»åŠ æ’ååˆ—ï¼ˆä»1å¼€å§‹ï¼‰
        brand_stats['rank'] = range(1, len(brand_stats) +1)
        
        # é‡å‘½ååˆ—ä»¥åŒ¹é…æœŸæœ›çš„è¾“å‡ºæ ¼å¼
        ranking_data = brand_stats.rename(columns={
            'brand_name': 'Brand',
            'total_score': 'Score',
            'rank': 'Rank'
        })
        
        # é€‰æ‹©éœ€è¦çš„åˆ—
        ranking_data = ranking_data[['Brand', 'Score', 'Rank']]
    # å¤„ç†é¥¼å›¾æ•°æ®
    pie_labels = brand_stats['brand_name'].tolist()
    pie_values = brand_stats['total_score'].tolist()
    return trend_data, ranking_data, pie_labels, pie_values,latest_r_brand_amount,latest_link_amount,latest_nr_brand_amount 

 

def _get_default_data():
    # ç”Ÿæˆé»˜è®¤æ—¥æœŸèŒƒå›´
    dates = [(datetime.now() - timedelta(days=i)).strftime('%Y-%m-%d') for i in range(29, -1, -1)]
    
    # é»˜è®¤è¶‹åŠ¿æ•°æ®
    trend_data = {
        "Date": dates,
        "Brand": [0] * 30,
        "Link": [0] * 30
    }
    
    # é»˜è®¤æ’è¡Œæ¦œæ•°æ®
    rank_data = pd.DataFrame({
        'Brand': ['æš‚æ— æ•°æ®'],
        'Score': [0],
        'Rank': [1]
    })
    
    # é»˜è®¤é¥¼å›¾æ•°æ®
    BrandsP = ['æš‚æ— æ•°æ®']
    values = [100]
    
    latest_r_brand_amount = 0
    latest_nr_brand_amount = 0
    latest_link_amount = 0
    return trend_data, rank_data, BrandsP, values,latest_r_brand_amount,latest_link_amount,latest_nr_brand_amount 
# --- 2. å¸ƒå±€è®¾è®¡ ---
app.layout = html.Div([
    dcc.Location(id="url", refresh=False),
    dcc.Store(id='lang-store', data='zh'),
    dcc.Store(id='app-state', data={
        'current_page': 'brand',
        'brand_step': 'input',
        'brand_name': '',
        'keyword': '',
        'link': ''
    }),
    
    # === A. é¡¶éƒ¨å¯¼èˆªæ  (å·²å‡çº§å“ç‰Œå±•ç¤º) ===
    dbc.Navbar(
        dbc.Container([
            dbc.Row([
                #1. Logo
                dbc.Col(
                    html.Img(src="/static/images/logo.png", className="navbar-logo"),
                    width="auto"
                ),
                #2. å“ç‰Œæ–‡å­—åŒº
                dbc.Col([
                    html.H4(
                        "Istar GEO Evaluator",
                        className="mb-0 fw-bold",
                        style={
                            "color": "#344767",
                            "fontSize": "1.25rem",
                            "lineHeight": "1.2"
                        }
                    ),
                    html.Small(
                        "åŸºäº RAG æŠ€æœ¯çš„å“ç‰Œ AI å¯è§åº¦ä¸å£°é‡ç›‘æµ‹å¹³å°",
                        className="text-muted",
                        style={"fontSize": "0.75rem"}
                    )
                ], className="ps-2 d-flex flex-column justify-content-center"),
 
                #3. èœå•é“¾æ¥
                dbc.Col(
                    dbc.Nav([
                        dbc.NavItem(dbc.NavLink(
                            "å“ç‰ŒAIå¯è§åº¦",
                            id="nav-brand",
                            href="/dashboard/brand/",
                            active=True,
                            className="nav-link-custom"
                        )),
                        dbc.NavItem(dbc.NavLink(
                            "GEOæœåŠ¡å•†",
                            id="nav-geo",
                            href="/dashboard/geo-evaluate/",
                            className="nav-link-custom"
                        )),
                        dbc.NavItem(dbc.NavLink(
                            "AIæŠ•æ¯’",
                            id="nav-ai-toxic",
                            href="/dashboard/ai-toxic/",
                            className="nav-link-custom"
                        )),
                        dbc.NavItem(dbc.NavLink(
                            "CGEOçŸ¥è¯†åº“",
                            id="nav-cgeo-wiki",
                            href="/dashboard/cgeo-wiki/",
                            className="nav-link-custom"
                        )),
                        dbc.NavItem(dbc.NavLink(
                            "å…³äºæˆ‘ä»¬",
                            id="nav-about",
                            href="/dashboard/about/",
                            className="nav-link-custom"
                        )),
                    ], className="ms-5 d-none d-lg-flex"),
                    width=True
                ),
            ], align="center", className="flex-grow-1"),
            
            # å³ä¾§ï¼šè¯­è¨€ + ç™»å½•
    dbc.Row([
        dbc.Col(
            dbc.Switch(
                id="lang-switch", value=False, className="me-3"
            ),
            width="auto"
        ),
        dbc.Col(
            html.Div(id="login-button-container", children=[
                html.A(
                    dbc.Button(
                        "ç™»å½•",
                        color="dark",
                        outline=True,
                        className="rounded-pill fw-bold px-4 btn-sm"
                    ),
                    href="/accounts/login/",
                    className="text-decoration-none",
                    id="login-button"
                )
            ]),
            width="auto"
        ),
        dbc.Col(
            html.Div(id="user-info-container", children=[]),
            width="auto"
        )
    ], align="center", className="g-0")
    ], fluid=True),className=
    "navbar-glass sticky-top mb-4"
    ),
    # === C. ä¸»è¦å†…å®¹åŒºåŸŸ ===
    html.Div(id="page-content", children=[]),
    dbc.Container([
 
        # --- æœç´¢æ§åˆ¶å° ---
        dbc.Card([
            dbc.CardBody([
                dbc.Row([
                    # ç›‘æµ‹å¯¹è±¡
                    dbc.Col([
                        html.Label(
                            id="lbl-search-brand",
                            className="small fw-bold text-secondary mb-1"
                        ),
                        dbc.Input(
                            id="input-search-brand",
                            className="form-control-premium"
                        )
                    ], width=12, md=4),
 
                    # æ ¸å¿ƒå…³é”®è¯
                    dbc.Col([
                        html.Label(
                            id="lbl-search-kw",
                            className="small fw-bold text-secondary mb-1"
                        ),
                        dbc.Input(
                            id="input-search-kw",
                            className="form-control-premium"
                        ),
                        html.Label(
                            id="lbl-search-link",
                            className="small fw-bold text-secondary mb-1"
                        ),
                        dbc.Input(
                            id="input-search-link",
                            className="form-control-premium"
                        )
                    ], width=12, md=4),
 
                    # æŒ‰é’® (åº•éƒ¨å¯¹é½)
                    dbc.Col([
                        html.Label(" ", className="d-block mb-1"),
                        dbc.Button(
                            id="btn-analyze",
                            className="w-100 fw-bold shadow-sm mb-2",
                            color="dark",
                            n_clicks=0
                        ),
                        dbc.Button(
                            id="btn-download",
                            className="w-100 fw-bold shadow-sm",
                            color="primary",
                            n_clicks=0
                        )
                    ], width=12, md=4)
                ], className="g-3 align-items-end")
            ], className="p-4")
        ], className="premium-card mb-5 border-0 shadow-sm"),
 
        # æ·»åŠ ä¸‹è½½ç»„ä»¶
        dcc.Download(id="download-dataframe-csv"),
 
        dcc.Loading(
            id="loading",
            type="cube",
            color="#cb0c9f",
            children=[
                # 1. ä¸‰ä¸ªå¤§å¡ç‰‡ KPI
                dbc.Row([
                    dbc.Col(dbc.Card([
                        dbc.CardBody([
                            html.Div(
                                id="label-kpi-1",
                                className="card-label mb-2"
                            ),
                            html.Div([
                                html.Span(
                                    id="val-1",
                                    className="metric-value"
                                ),
                                html.Span(id="bad-1")
                            ])
                        ])
                    ], className="premium-card h-100 delay-1"),
                        width=12, lg=4, className="mb-4"),
 
                    dbc.Col(dbc.Card([
                        dbc.CardBody([
                            html.Div(
                                id="label-kpi-2",
                                className="card-label mb-2"
                            ),
                            html.Div([
                                html.Span(
                                    id="val-2",
                                    className="metric-value"
                                ),
                                html.Span(id="bad-2")
                            ])
                        ])
                    ], className="premium-card h-100 delay-2"),
                        width=12, lg=4, className="mb-4"),
 
                    dbc.Col(dbc.Card([
                        dbc.CardBody([
                            html.Div(
                                id="label-kpi-3",
                                className="card-label mb-2"
                            ),
                            html.Div([
                                html.Span(
                                    id="val-3",
                                    className="metric-value"
                                ),
                                html.Span(id="bad-3")
                            ])
                        ])
                    ], className="premium-card h-100 delay-3"),
                        width=12, lg=4, className="mb-4")
                ]),
 
                # 2. å›¾è¡¨åŒº
                dbc.Row([
                    dbc.Col(dbc.Card([
                        dbc.CardHeader(
                            id="title-trend",
                            className="bg-transparent border-0 fw-bold pt-4 ps-4"
                        ),
                        dbc.CardBody(
                            dcc.Graph(
                                id='chart-trend',
                                config={'displayModeBar': False},
                                style={"height": "320px"}
                            )
                        )
                    ], className="premium-card h-100"), width=12, lg=8, className="mb-4"),
 
                    dbc.Col(dbc.Card([
                        dbc.CardHeader(
                            id="title-pie",
                            className="bg-transparent border-0 fw-bold pt-4 ps-4"
                        ),
                        dbc.CardBody(
                            dcc.Graph(
                                id='chart-pie',
                                config={'displayModeBar': False},
                                style={"height": "320px"}
                            )
                        )
                    ], className="premium-card h-100"), width=12, lg=4, className="mb-4")
                ]),
 
                # 3. æ’è¡Œæ¦œ
                dbc.Row([
                    dbc.Col(dbc.Card([
                        dbc.CardHeader(
                            id="title-rank",
                            className="bg-transparent border-0 fw-bold pt-4 ps-4"
                        ),
                        dbc.CardBody(id='rank-container', className="p-4")
                    ], className="premium-card"), width=12)
                ])
            ]
        )
    ], fluid=True, className="px-lg-5 pb-5"),

    dcc.Interval(id="interval-trigger", interval=120 * 1000, n_intervals=0),
    # éšè—çš„ DataTable é˜²æ­¢ Import unused æŠ¥é”™
    html.Div(dash_table.DataTable(id='hidden'), style={'display': 'none'}),
    # ç”¨äºæ¥æ”¶é€€å‡ºç™»å½•JavaScriptçš„éšè—div
    html.Div(id='logout-redirect', style={'display': 'none'}),

    # ç”¨äºæ§åˆ¶è·³è½¬çš„Locationç»„ä»¶
    dcc.Location(id="redirect-location", refresh=False),

    # æ— è®¢å•æç¤ºæ¨¡æ€çª—å£
    dbc.Modal(
        [
            dbc.ModalHeader(dbc.ModalTitle("æç¤º", className="fw-bold")),
            dbc.ModalBody(
                html.Div([
                    html.P(id="no-order-message", className="mb-3"),
                    html.P(id="no-order-detail", className="text-muted small mb-3"),
                    html.A(
                        dbc.Button("åˆ›å»ºè®¢å•", color="primary", className="w-100", size="lg"),
                        href="/api/redirect-to-create-order/",
                        id="create-order-link",
                        className="text-decoration-none"
                    )
                ])
            ),
        ],
        id="no-order-modal",
        is_open=False,
        backdrop="static",
        centered=True,
        size="lg"
    ),

    # å®¢æˆ·ç«¯è„šæœ¬ï¼šç™»å½•çŠ¶æ€æ£€æŸ¥å’ŒæŒ‰é’®æ›´æ–°
    html.Script("""
        (function() {
            // ========== 1. Toast åŠŸèƒ½ ==========
            function showToast(message, duration) {
                const toast = document.getElementById('toast');
                const messageElement = document.getElementById('toast-message');
                
                messageElement.textContent = message;
                toast.classList.add('show');
                
                setTimeout(function() {
                    hideToast();
                }, duration || 5000);
            }
            
            function hideToast() {
                const toast = document.getElementById('toast');
                toast.style.animation = 'slideOut 0.3s ease-out forwards';
                setTimeout(function() {
                    toast.classList.remove('show');
                    toast.style.animation = '';
                }, 300);
            }
            
            // ========== 2. æ£€æŸ¥URLå‚æ•° ==========
            function checkUrlParams() {
                const params = new URLSearchParams(window.location.search);
                const loginSuccess = params.get('login_success');
                const registerSuccess = params.get('register_success');
                const username = params.get('username');
                
                if (loginSuccess === 'true' && username) {
                    showToast('æ¬¢è¿å›æ¥ï¼Œ' + username + 'ï¼');
                    localStorage.setItem('authState', JSON.stringify({
                        authenticated: true,
                        username: username
                    }));
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else if (registerSuccess === 'true' && username) {
                    showToast('æ³¨å†ŒæˆåŠŸï¼Œæ¬¢è¿ ' + username + 'ï¼');
                    localStorage.setItem('authState', JSON.stringify({
                        authenticated: true,
                        username: username
                    }));
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
            
            // ========== 3. æ›´æ–°æŒ‰é’®æ˜¾ç¤º ==========
            function updateAuthButtons(authenticated, username) {
                const loginButton = document.getElementById('login-button');
                const userContainer = document.getElementById('user-info-container');
                
                if (authenticated && username) {
                    if (loginButton) {
                        loginButton.style.display = 'none';
                    }
                    if (userContainer) {
                        userContainer.innerHTML = '<a href="/accounts/profile/" class="text-decoration-none"><button class="btn btn-outline-dark btn-sm rounded-pill fw-bold px-4">' + username + '</button></a>';
                    }
                } else {
                    if (loginButton) {
                        loginButton.style.display = 'block';
                    }
                    if (userContainer) {
                        userContainer.innerHTML = '';
                    }
                }
            }
            
            // ========== 4. ä»localStorageæ¢å¤ç™»å½•çŠ¶æ€ ==========
            function loadAuthState() {
                try {
                    const authState = localStorage.getItem('authState');
                    if (authState) {
                        const data = JSON.parse(authState);
                        if (data.authenticated && data.username) {
                            updateAuthButtons(true, data.username);
                        }
                    }
                } catch (error) {
                    console.log('åŠ è½½ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                }
            }
            
            // ========== 5. æœåŠ¡å™¨ç™»å½•çŠ¶æ€æ£€æŸ¥ ==========
            async function checkServerAuthStatus() {
                try {
                    const response = await fetch('/accounts/api/auth-check/');
                    const data = await response.json();
                    
                    if (data.authenticated && data.username) {
                        localStorage.setItem('authState', JSON.stringify({
                            authenticated: true,
                            username: data.username
                        }));
                        updateAuthButtons(true, data.username);
                    } else {
                        localStorage.removeItem('authState');
                        updateAuthButtons(false, null);
                    }
                } catch (error) {
                    console.log('æ£€æŸ¥æœåŠ¡å™¨ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                    loadAuthState();
                }
            }
            
             // ========== 6. åˆå§‹åŒ– ==========
             window.addEventListener('DOMContentLoaded', function() {
                 // 1. æ£€æŸ¥URLå‚æ•°ï¼ˆç™»å½•/æ³¨å†ŒæˆåŠŸï¼‰
                 checkUrlParams();
                 
                 // 2. ä»localStorageæ¢å¤ç™»å½•çŠ¶æ€
                 loadAuthState();
                 
                 // 3. å»¶è¿Ÿæ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€ï¼ˆé¿å…é¡µé¢åˆšåŠ è½½æ—¶çš„å†²çªï¼‰
                 setTimeout(checkServerAuthStatus, 1000);
                 
                 // 4. æ¯60ç§’æ£€æŸ¥ä¸€æ¬¡æœåŠ¡å™¨çŠ¶æ€
                 setInterval(checkServerAuthStatus, 60000);
                 
                 // 5. ç»‘å®šæŠ¥å‘Šé¡µé¢æŒ‰é’®äº‹ä»¶
                 const downloadImageButton = document.getElementById('btn-report-download-image');
                 const copyLinkButton = document.getElementById('btn-report-copy-link');
                 
                 if (downloadImageButton) {
                     downloadImageButton.addEventListener('click', function() {
                         downloadAsImage('png');
                     });
                 }
                 
                 if (copyLinkButton) {
                     copyLinkButton.addEventListener('click', function() {
                         copyLink();
                     });
                 }
             });
             
             // ========== 7. ç½‘é¡µåˆ†äº«åŠŸèƒ½ ==========
             function downloadAsImage(format) {
                 showToast('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...');
                 
                 // åŠ¨æ€åŠ è½½ html2canvas
                 const script = document.createElement('script');
                 script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                 script.onload = function() {
                     html2canvas(document.body).then(canvas => {
                         const link = document.createElement('a');
                         link.download = `brand_dashboard.${format.toLowerCase()}`;
                         link.href = canvas.toDataURL(`image/${format}`);
                         link.click();
                         showToast('å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼');
                     }).catch(err => {
                         console.error('ä¸‹è½½å›¾ç‰‡å¤±è´¥:', err);
                         showToast('å›¾ç‰‡ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                     });
                 };
                 document.head.appendChild(script);
             }
             
             function copyLink() {
                 const url = window.location.href;
                 navigator.clipboard.writeText(url).then(() => {
                     showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                 }).catch(err => {
                     console.error('å¤åˆ¶é“¾æ¥å¤±è´¥:', err);
                     showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•');
                 });
             }
         })();
    """)
])

@app.callback(
    Output('app-state', 'data'),
    Input('url', 'pathname'),
    Input('url', 'search')
)
def update_app_state(pathname, search):
    from urllib.parse import parse_qs
    
    params = parse_qs(search.lstrip('?'))
    
    current_page = 'brand'
    brand_step = 'input'
    
    if pathname.startswith('/dashboard/brand/'):
        current_page = 'brand'
        brand_step = params.get('step', ['input'])[0]
    elif pathname.startswith('/dashboard/geo-evaluate/'):
        current_page = 'geo-evaluate'
    elif pathname.startswith('/dashboard/ai-toxic/'):
        current_page = 'ai-toxic'
    elif pathname.startswith('/dashboard/cgeo-wiki/'):
        current_page = 'cgeo-wiki'
    elif pathname.startswith('/dashboard/about/'):
        current_page = 'about'
    
    return {
        'current_page': current_page,
        'brand_step': brand_step,
        'brand_name': '',
        'keyword': '',
        'link': ''
    }

@app.callback(
    [Output('nav-brand', 'active'),
     Output('nav-geo', 'active'),
     Output('nav-ai-toxic', 'active'),
     Output('nav-cgeo-wiki', 'active'),
     Output('nav-about', 'active')],
    Input('url', 'pathname')
)
def update_nav_active(pathname):
    return [
        pathname.startswith('/dashboard/brand/'),
        pathname.startswith('/dashboard/geo-evaluate/'),
        pathname.startswith('/dashboard/ai-toxic/'),
        pathname.startswith('/dashboard/cgeo-wiki/'),
        pathname.startswith('/dashboard/about/')
    ]

@app.callback(
    Output('page-content', 'children'),
    Input('app-state', 'data')
)
def display_page(state):
    current_page = state.get('current_page', 'brand')
    brand_step = state.get('brand_step', 'input')
    
    if current_page == 'brand':
        if brand_step == 'input':
            return get_brand_input_page()
        else:
            return get_brand_report_page()
    elif current_page == 'geo-evaluate':
        return get_geo_evaluate_page()
    elif current_page == 'ai-toxic':
        return get_ai_toxic_page()
    elif current_page == 'cgeo-wiki':
        return get_cgeo_wiki_page()
    elif current_page == 'about':
        return get_about_page()
    
    return html.Div("404 - é¡µé¢æœªæ‰¾åˆ°")

def get_brand_input_page():
    return html.Div([
        dbc.Container([
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H2("å“ç‰ŒAIå¯è§åº¦åˆ†æ", className="text-center mb-4"),
                            html.P("è¾“å…¥æ‚¨è¦ç›‘æµ‹çš„å“ç‰Œåç§°", className="text-center text-muted mb-4"),
                            dbc.Input(
                                id='input-brand',
                                placeholder='å¦‚ï¼šNike',
                                className="mb-3"
                            ),
                            dbc.Button("ä¸‹ä¸€æ­¥", id='btn-next-brand', className="w-100")
                        ])
                    ], className="premium-card", id="brand-step-1-card")
                ], width=6, className="mx-auto mt-5"),
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H2("å“ç‰ŒAIå¯è§åº¦åˆ†æ", className="text-center mb-4"),
                            html.P("è¾“å…¥æ ¸å¿ƒå…³é”®è¯", className="text-center text-muted mb-4"),
                            dbc.Input(
                                id='input-keyword',
                                placeholder='å¦‚ï¼šè“ç‰™è€³æœº',
                                className="mb-3"
                            ),
                            dbc.Button("ä¸‹ä¸€æ­¥", id='btn-next-keyword', className="w-100 mb-2"),
                            dbc.Button("ä¸Šä¸€æ­¥", id='btn-prev-keyword', className="w-100")
                        ])
                    ], className="premium-card", id="brand-step-2-card", style={'display': 'none'})
                ], width=6, className="mx-auto mt-5"),
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H2("å“ç‰ŒAIå¯è§åº¦åˆ†æ", className="text-center mb-4"),
                            html.P("è¾“å…¥ä¿¡æºé“¾æ¥ï¼ˆé€‰å¡«ï¼‰", className="text-center text-muted mb-4"),
                            dbc.Input(
                                id='input-link',
                                placeholder='å¦‚ï¼šhttps://example.com',
                                className="mb-3"
                            ),
                            dbc.Button("å¼€å§‹åˆ†æ", id='btn-start-analyze', className="w-100 mb-2"),
                            dbc.Button("ä¸Šä¸€æ­¥", id='btn-prev-link', className="w-100")
                        ])
                    ], className="premium-card", id="brand-step-3-card", style={'display': 'none'})
                ], width=6, className="mx-auto mt-5")
            ])
        ], fluid=True, className="px-lg-5")
    ], id="brand-input-container")

def get_brand_report_page():
    return html.Div([
        dbc.Row([
            dbc.Col([
                html.Div([
                    dbc.Card([
                        dbc.CardBody([
                            html.Div(
                                id="report-label-kpi-1",
                                className="card-label mb-2"
                            ),
                            html.Div([
                                html.Span(
                                    id="report-val-1",
                                    className="metric-value"
                                ),
                                html.Span(id="report-bad-1")
                            ])
                        ])
                    ], className="premium-card h-100 delay-1"),
                    
                    dbc.Card([
                        dbc.CardBody([
                            html.Div(
                                id="report-label-kpi-2",
                                className="card-label mb-2"
                            ),
                            html.Div([
                                html.Span(
                                    id="report-val-2",
                                    className="metric-value"
                                ),
                                html.Span(id="report-bad-2")
                            ])
                        ])
                    ], className="premium-card h-100 delay-2"),
                    
                    dbc.Card([
                        dbc.CardBody([
                            html.Div(
                                id="report-label-kpi-3",
                                className="card-label mb-2"
                            ),
                            html.Div([
                                html.Span(
                                    id="report-val-3",
                                    className="metric-value"
                                ),
                                html.Span(id="report-bad-3")
                            ])
                        ])
                    ], className="premium-card h-100 delay-3"),
                    
                    dbc.Card([
                        dbc.CardHeader("è§£é‡Šåˆ†æ", className="bg-transparent border-0 fw-bold pt-4 ps-4"),
                        dbc.CardBody("è¿™é‡Œæ˜¯è¯¦ç»†çš„åˆ†æè¯´æ˜...")
                    ], className="mb-3"),
                    
                    dbc.Card([
                        dbc.CardHeader("ç”¨æˆ·åè®®", className="bg-transparent border-0 fw-bold pt-4 ps-4"),
                        dbc.CardBody("è¿™é‡Œæ˜¯ç”¨æˆ·åè®®å†…å®¹...")
                    ], className="mb-3"),
                    
                    dbc.Card([
                        dbc.CardHeader("å…è´£å£°æ˜", className="bg-transparent border-0 fw-bold pt-4 ps-4"),
                        dbc.CardBody("è¿™é‡Œæ˜¯å…è´£å£°æ˜å†…å®¹...")
                    ], className="mb-3")
                ], className="overflow-auto", style={'height': 'calc(100vh - 200px)'})
            ], width=12, lg=4),
            
            dbc.Col([
                dbc.Card([
                    dbc.CardHeader("è¶‹åŠ¿åˆ†æ", className="bg-transparent border-0 fw-bold pt-4 ps-4"),
                    dbc.CardBody(
                        dcc.Graph(
                            id='report-chart-trend',
                            config={'displayModeBar': False},
                            style={"height": "320px"}
                        )
                    )
                ], className="premium-card mb-4"),
                
                dbc.Card([
                    dbc.CardHeader("ç«å“æ’è¡Œæ¦œ", className="bg-transparent border-0 fw-bold pt-4 ps-4"),
                    dbc.CardBody(id='report-rank-container', className="p-4")
                ], className="premium-card mb-4"),
                
                dbc.Card([
                    dbc.CardHeader("å¼•ç”¨å æ¯”", className="bg-transparent border-0 fw-bold pt-4 ps-4"),
                    dbc.CardBody(
                        dcc.Graph(
                            id='report-chart-pie',
                            config={'displayModeBar': False},
                            style={"height": "320px"}
                        )
                    )
                ], className="premium-card mb-4"),
                
                dbc.Button("å¯¼å‡ºåˆ†ææŠ¥å‘Š", id='btn-report-download', className="w-100 mb-2", color="primary"),
                dbc.ButtonGroup([
                    dbc.Button("ä¸‹è½½ç½‘é¡µå›¾ç‰‡", id='btn-report-download-image', className="w-50"),
                    dbc.Button("å¤åˆ¶é“¾æ¥", id='btn-report-copy-link', className="w-50")
                ], className="w-100 mb-4"),
                
                dbc.Button("æˆ‘å·²çŸ¥æ™“å¹¶æ„¿æ„", id='btn-report-agree', className="w-100", color="dark")
            ], width=12, lg=8)
        ])
    ])

def get_geo_evaluate_page():
    return html.Div([
        html.H2("GEOæœåŠ¡å•†åˆ†æ", className="text-center mb-4"),
        dbc.Card([
            dbc.CardBody([
                html.P("æ­£åœ¨å¼€å‘ä¸­...")
            ])
        ])
    ])

def get_ai_toxic_page():
    return html.Div([
        html.H2("AIæŠ•æ¯’å¯è§†åŒ–", className="text-center mb-4"),
        dbc.Card([
            dbc.CardBody([
                html.P("æ­£åœ¨å¼€å‘ä¸­...")
            ])
        ])
    ])

def get_cgeo_wiki_page():
    return html.Div([
        html.H2("CGEOå¼€æºçŸ¥è¯†åº“", className="text-center mb-4"),
        dbc.Card([
            dbc.CardBody([
                html.P("æ­£åœ¨å¼€å‘ä¸­...")
            ])
        ])
    ])

def get_about_page():
    return html.Div([
        dbc.Container([
            html.H2("å…³äºæˆ‘ä»¬", className="text-center mb-4"),
            dbc.Row([
                dbc.Col([
                    html.H4("å‘æˆ‘ä»¬æä¾›ä¿¡æ¯"),
                    dbc.Button("å¡«å†™é—®å·", href="https://example.com/survey", external_link=True)
                ], className="mb-4 p-4 bg-light rounded"),
            ], width=6),
            dbc.Row([
                dbc.Col([
                    html.H4("æ”¯æŒæˆ‘ä»¬"),
                    dbc.ButtonGroup([
                        dbc.Button("æ”¯ä»˜å®", href="https://example.com/alipay", external_link=True),
                        dbc.Button("å¾®ä¿¡æ”¯ä»˜", href="https://example.com/wechat", external_link=True)
                    ])
                ], className="mb-4 p-4 bg-light rounded"),
            ], width=6),
            dbc.Row([
                dbc.Col([
                    html.H4("è”ç³»æˆ‘ä»¬"),
                    html.Ul([
                        html.Li("ğŸ“ ç”µè¯ï¼šxxx-xxxx-xxxx"),
                        html.Li("âœ‰ï¸ é‚®ç®±ï¼šcontact@example.com"),
                        html.Li("ğŸ¦ GitHub: @your-org"),
                        html.Li("ğŸ¦ Twitter: @your-org"),
                    ])
                ], className="p-4 bg-light rounded")
            ])
        ], className="mt-5")
    ])

@app.callback(
    Output('brand-step-1-card', 'style'),
    Output('brand-step-2-card', 'style'),
    Output('brand-step-3-card', 'style'),
    Output('app-state', 'data', allow_duplicate=True),
    Input('btn-next-brand', 'n_clicks'),
    Input('btn-prev-keyword', 'n_clicks'),
    Input('btn-next-keyword', 'n_clicks'),
    Input('btn-prev-link', 'n_clicks'),
    [State('input-brand', 'value'),
     State('input-keyword', 'value'),
     State('input-link', 'value'),
     State('app-state', 'data')],
    prevent_initial_call=True
)
def update_input_step(next_brand, prev_keyword, next_keyword, prev_link, brand, keyword, link, state):
    ctx = dash.callback_context
    if not ctx.triggered:
        return dash.no_update, dash.no_update, dash.no_update, dash.no_update
    
    trigger_id = ctx.triggered[0]['prop_id'].split('.')[0]
    
    new_state = state.copy()
    
    if trigger_id == 'btn-next-brand':
        return {'display': 'none'}, {'display': 'block'}, {'display': 'none'}, {**new_state, 'brand_name': brand or ''}
    elif trigger_id == 'btn-prev-keyword':
        return {'display': 'block'}, {'display': 'none'}, {'display': 'none'}, dash.no_update
    elif trigger_id == 'btn-next-keyword':
        return {'display': 'none'}, {'display': 'none'}, {'display': 'block'}, {**new_state, 'keyword': keyword or ''}
    elif trigger_id == 'btn-prev-link':
        return {'display': 'none'}, {'display': 'block'}, {'display': 'none'}, dash.no_update
    
    return dash.no_update, dash.no_update, dash.no_update, dash.no_update

@app.callback(
    Output('url', 'pathname', allow_duplicate=True),
    Output('app-state', 'data', allow_duplicate=True),
    Input('btn-start-analyze', 'n_clicks'),
    [State('input-brand', 'value'),
     State('input-keyword', 'value'),
     State('input-link', 'value'),
     State('app-state', 'data')],
    prevent_initial_call=True
)
def start_analysis(n_clicks, brand, keyword, link, state):
    if not n_clicks:
        return dash.no_update, dash.no_update
    
    new_state = state.copy()
    new_state['brand_name'] = brand or ''
    new_state['keyword'] = keyword or ''
    new_state['link'] = link or ''
    new_state['brand_step'] = 'report'
    
    return '/dashboard/brand/?step=report', new_state

@app.callback(
    [Output('report-label-kpi-1', 'children'),
     Output('report-val-1', 'children'),
     Output('report-bad-1', 'children'),
     Output('report-label-kpi-2', 'children'),
     Output('report-val-2', 'children'),
     Output('report-bad-2', 'children'),
     Output('report-label-kpi-3', 'children'),
     Output('report-val-3', 'children'),
     Output('report-bad-3', 'children'),
     Output('report-chart-trend', 'figure'),
     Output('report-chart-pie', 'figure'),
     Output('report-rank-container', 'children')],
    Input('app-state', 'data'),
    prevent_initial_call=False
)
def update_report_data(state):
    current_page = state.get('current_page', 'brand')
    brand_step = state.get('brand_step', 'input')
    
    if current_page != 'brand' or brand_step != 'report':
        return dash.no_update, dash.no_update, dash.no_update, dash.no_update, dash.no_update, dash.no_update, dash.no_update, dash.no_update, dash.no_update, dash.no_update, dash.no_update, dash.no_update
    
    brand_name = state.get('brand_name', '')
    keyword = state.get('keyword', '')
    link = state.get('link', '')
    
    data = fetch_backend_data(brand_name=brand_name, keyword_name=keyword, link_name=link)
    
    if isinstance(data, dict) and data.get("no_order"):
        return "æš‚æ— æ•°æ®", "0%", "", "æš‚æ— æ•°æ®", "0%", "", "æš‚æ— æ•°æ®", "0%", "", go.Figure(), go.Figure(), html.P("æš‚æ— è®¢å•æ•°æ®")
    
    trend, rank, pie_l, pie_v, latest_r_brand_amount, latest_link_amount, latest_nr_brand_amount = _convert_to_web_format(data, brand_name)
    
    def badge(v):
        change = np.random.randint(-10, 20)
        if change > 0:
            color, icon = "#ecfdf5", "text-success â–²"
        else:
            color, icon = "#fef2f2", "text-danger â–¼"
        
        return f"{v}%", html.Span(
            f"{icon} {abs(change)}%",
            className="trend-badge",
            style={"background": color}
        )
    
    fig1 = go.Figure()
    fig1.add_trace(go.Scatter(
        x=trend["Date"], y=trend["Brand"], name="Brand Traffic",
        fill='tozeroy',
        line=dict(color="#d61616", width=3, shape='spline')
    ))
    fig1.add_trace(go.Scatter(
        x=trend["Date"], y=trend["Link"], name="Link Traffic",
        line=dict(color="#152FC2", width=3, shape='spline')
    ))
    fig1.update_layout(
        template="plotly_white",
        margin=dict(l=20, r=20, t=10, b=20),
        hovermode="x unified",
        legend=dict(orientation="h", y=1.1)
    )
    
    fig2 = go.Figure(data=[go.Pie(
        labels=pie_l, values=pie_v, hole=.7,
        textinfo='percent', textposition='outside',
        marker=dict(colors=px.colors.qualitative.Pastel)
    )])
    fig2.update_layout(
        showlegend=True,
        margin=dict(l=20, r=20, t=0, b=20),
        legend=dict(orientation="h")
    )
    
    ranks = []
    for _, r in rank.iterrows():
        rk = r['Rank']
        cls = f"rank-{rk}" if rk <= 3 else "rank-other"
        
        ranks.append(dbc.Row([
            dbc.Col(
                html.Div(f"{rk}", className=f"rank-circle {cls}"),
                width="auto"
            ),
            dbc.Col(
                html.Span(
                    r['Brand'],
                    className="fw-bold ms-3"
                ),
                width=True
            ),
            dbc.Col(
                html.Span(f"{r['Score']}", className="fw-bold text-dark"),
                width="auto"
            )
        ], className="ranking-item align-items-center"))
    
    v1, b1 = badge(latest_r_brand_amount)
    v2, b2 = badge(latest_link_amount)
    v3, b3 = badge(latest_nr_brand_amount)
    
    return (
        "æ ¸å¿ƒå“ç‰ŒæåŠæ¦‚ç‡(æ¨èæ€§ä»»åŠ¡)", v1, b1,
        "é“¾æ¥æåŠæ¦‚ç‡", v2, b2,
        "å“ç‰ŒæåŠæ¦‚ç‡(éšæ„æ€§ä»»åŠ¡)", v3, b3,
        fig1, fig2, ranks
    )

@app.callback(
    Output("download-dataframe-csv", "data"),
    Input("btn-report-download", "n_clicks"),
    [State('app-state', 'data')],
    prevent_initial_call=True,
)
def export_report_csv(n_clicks, state):
    if not n_clicks:
        return dash.no_update
    
    brand_name = state.get('brand_name', '')
    keyword = state.get('keyword', '')
    link = state.get('link', '')
    
    df = fetch_backend_data(brand_name=brand_name, keyword_name=keyword, link_name=link)
    
    if isinstance(df, list) and len(df) > 0 and df[0] == 404:
        df = pd.DataFrame({'Error': ['Data not found or API error']})
    elif isinstance(df, tuple):
        df = pd.DataFrame({'Info': ['No data available for export']})
    elif df is None or not isinstance(df, pd.DataFrame) or df.empty:
        df = pd.DataFrame({'Info': ['No data available for export']})
    
    return dcc.send_data_frame(df.to_csv, "brand_ai_report.csv", index=False)
# C. æ•°æ®å›¾è¡¨æ¸²æŸ“ (ç›‘å¬è‡ªåŠ¨åˆ·æ–° OR æ‰‹åŠ¨ç‚¹å‡»åˆ†æ)
@app.callback(
    [Output('val-1', 'children'), Output('bad-1', 'children'),
     Output('val-2', 'children'), Output('bad-2', 'children'),
     Output('val-3', 'children'), Output('bad-3', 'children'),
     Output('chart-trend', 'figure'), Output('chart-pie', 'figure'),
     Output('rank-container', 'children'),
     Output('no-order-modal', 'is_open'),
     Output('no-order-message', 'children'),
     Output('no-order-detail', 'children'),
     Output('create-order-link', 'href')],
     [Input('interval-trigger', 'n_intervals'),
      Input('btn-analyze', 'n_clicks')],

    [State('input-search-brand', 'value'),State('input-search-kw', 'value'),State('input-search-link', 'value')]
)
def update_metrics(n_interval, n_click, search_brand, search_keyword, search_link):
    # æ£€æŸ¥æ˜¯å¦æ˜¯ç‚¹å‡»äº†åˆ†ææŒ‰é’®
    ctx = dash.callback_context
    if not ctx.triggered:
        return (dash.no_update, dash.no_update, dash.no_update, dash.no_update,
                dash.no_update, dash.no_update, dash.no_update, dash.no_update,
                dash.no_update, False, "", "", dash.no_update)

    trigger_id = ctx.triggered[0]['prop_id'].split('.')[0]

    # è·å–æ•°æ®
    data = fetch_backend_data(brand_name=search_brand, keyword_name=search_keyword, link_name=search_link)

    # æ£€æŸ¥æ˜¯å¦æ²¡æœ‰è®¢å•
    if isinstance(data, dict) and data.get("no_order"):
        brand_name = data.get("brand_name", "")
        keyword_name = data.get("keyword", "")
        create_order_href = f"/api/redirect-to-create-order/?brand_name={brand_name}&keyword_name={keyword_name}"

        # æ‰“å¼€Modalï¼Œæ˜¾ç¤ºæ— è®¢å•æç¤º
        return (
            "0%", "", "0%", "", "0%", "",
            go.Figure(), go.Figure(), "",
            True,  # æ‰“å¼€Modal
            f"ç³»ç»Ÿä¸­æš‚æ— å…³äº '{brand_name}' å’Œ '{keyword_name}' çš„è®¢å•æ•°æ®ã€‚",
            f"å“ç‰Œï¼š{brand_name} | å…³é”®è¯ï¼š{keyword_name}",
            create_order_href
        )
    # è§¦å‘ fetch_dataï¼Œä¼ å…¥æœç´¢è¯
    trend, rank, pie_l, pie_v ,latest_r_brand_amount,latest_link_amount,latest_nr_brand_amount = _convert_to_web_format(fetch_backend_data(brand_name=search_brand,keyword_name=search_keyword,link_name=search_link),search_brand)

    def badge(v):
        change = np.random.randint(-10, 20)
        if change > 0:
            color, icon = "#ecfdf5", "text-success â–²"
        else:
            color, icon = "#fef2f2", "text-danger â–¼"

        return f"{v}%", html.Span(
            f"{icon} {abs(change)}%",
            className="trend-badge",
            style={"background": color}
        )

    # 1. è¶‹åŠ¿å›¾
    fig1 = go.Figure()
    fig1.add_trace(go.Scatter(
        x=trend["Date"], y=trend["Brand"], name="Brand Traffic",
        fill='tozeroy',
        line=dict(color="#d61616", width=3, shape='spline')
    ))
    fig1.add_trace(go.Scatter(
        x=trend["Date"], y=trend["Link"], name="Link Traffic",
        line=dict(color="#152FC2", width=3, shape='spline')
    ))
    fig1.update_layout(
        template="plotly_white",
        margin=dict(l=20, r=20, t=10, b=20),
        hovermode="x unified",
        legend=dict(orientation="h", y=1.1)
    )

    # 2. é¥¼å›¾
    fig2 = go.Figure(data=[go.Pie(
        labels=pie_l, values=pie_v, hole=.7,
        textinfo='percent', textposition='outside',
        marker=dict(colors=px.colors.qualitative.Pastel)
    )])
    fig2.update_layout(
        showlegend=True,
        margin=dict(l=20, r=20, t=0, b=20),
        legend=dict(orientation="h")
    )

    # 3. æ’è¡Œæ¦œ
    ranks = []
    for _, r in rank.iterrows():
        rk = r['Rank']
        cls = f"rank-{rk}" if rk <= 3 else "rank-other"

        # å¦‚æœæ˜¯ç”¨æˆ·æœç´¢çš„å“ç‰Œ(æœ‰è¾“å…¥)ï¼ŒåŠ é‡æ˜¾ç¤º
        extra_style = {}
        if rk == search_brand:
            extra_style = {"color": "#cb0c9f"}

        ranks.append(dbc.Row([
            dbc.Col(
                html.Div(f"{rk}", className=f"rank-circle {cls}"),
                width="auto"
            ),
            dbc.Col(
                html.Span(
                    r['Brand'],
                    className="fw-bold ms-3",
                    style=extra_style
                ),
                width=True
            ),
            dbc.Col(
                html.Span(f"{r['Score']}", className="fw-bold text-dark"),
                width="auto"
            )
        ], className="ranking-item align-items-center"))
    
    
    v1, b1 = badge(latest_r_brand_amount)
    v2, b2 = badge(latest_link_amount)
    v3, b3 = badge(latest_nr_brand_amount)

    return v1, b1, v2, b2, v3, b3, fig1, fig2, ranks, False, "", "", dash.no_update


@app.callback(
    Output("download-dataframe-csv", "data"),
    Input("btn-download", "n_clicks"),
    [State('input-search-brand', 'value'),
     State('input-search-kw', 'value'),
     State('input-search-link','value')],
    prevent_initial_call=True,
)
def export_csv(n_clicks, search_brand, search_keyword,search_link):
    # è·å–çœŸå®æ•°æ®
    df = fetch_backend_data(brand_name=search_brand, keyword_name=search_keyword,link_name=search_link)
    
    # æ£€æŸ¥è¿”å›çš„æ•°æ®ç±»å‹
    if isinstance(df, list) and len(df) > 0 and df[0] == 404:
        # å¦‚æœè¿”å›çš„æ˜¯é”™è¯¯ç 
        df = pd.DataFrame({'Error': ['Data not found or API error']})
        #deflautæƒ…å†µ
    elif isinstance(df, tuple):
        df = pd.DataFrame({'Info': ['No data available for export']})
    elif df is None or df.empty:
        # å¦‚æœæ•°æ®ä¸ºç©º
        df = pd.DataFrame({'Info': ['No data available for export']})
    
    # ç¡®ä¿dfæ˜¯DataFrameç±»å‹
    if not isinstance(df, pd.DataFrame):
        df = pd.DataFrame({'Info': ['Unexpected data format']})
    
    # è¿”å›CSVæ•°æ®ä»¥ä¾›ä¸‹è½½
    return dcc.send_data_frame(df.to_csv, "dashboard_data.csv", index=False)
